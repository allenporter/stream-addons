#!/usr/bin/with-contenv bashio
#
# Update the RTSPtoWeb configuration based on the currently defined options.
# This is careful to preserve the existing config and only update the options
# so that any existins streams are preserved.

config=/data/config.json
config_bak=/data/config.json.bak
config_tmp=/data/config.json.tmp

bashio::log.info "Rewriting configuration"

debug=$(bashio::config 'debug' 'false')
log_level=$(bashio::config 'log_level' 'info')
http_port=$(bashio::config 'http_port' '8083')
rtsp_port=$(bashio::config 'rtsp_port' '5541')

cp ${config} ${config_bak}
cat ${config} \
    | jq ".server.debug = ${debug}" \
    | jq ".server.log_level = \"${log_level}\"" \
    | jq ".server.http_port = \":${http_port}\"" \
    | jq ".server.rtsp_port = \":${rtsp_port}\"" \
        > ${config_tmp}
mv ${config_tmp} ${config}
